# W-78: 보안 채널 데이터 디지털 암호화/서명 점검 보고서 (전문가용)

## 스크립트 설명

### 시스템 전제조건
- **도메인 멤버십**: 점검 대상 시스템은 Active Directory 도메인에 정상적으로 가입된 멤버여야 합니다.
- **서비스 상태**: NetLogon 서비스(`netlogon.dll`, `lsass.exe` 프로세스 내에서 실행)가 실행 중이어야 합니다. 이 서비스는 도메인 컨트롤러(DC)와의 보안 채널을 설정하고 유지 관리하는 핵심 주체입니다. 독립 실행형(Standalone) 서버는 이 점검의 대상이 아닙니다.

### 탐지 설명
- **공격 원리 및 위협**: 도메인 멤버가 부팅하거나 사용자가 로그온할 때, NetLogon 서비스는 DC와 보안 채널을 설정하고 이 채널을 통해 컴퓨터 계정 인증, Kerberos 티켓 요청, 사용자 인증 검증 등 극도로 민감한 통신을 수행합니다. 만약 이 채널이 암호화(Sealing)나 서명(Signing)으로 보호되지 않으면, 네트워크 중간에 위치한 공격자(Man-in-the-Middle)는 이 트래픽을 캡처하여 인증 과정을 재전송(Replay)하거나, 협상 과정을 다운그레이드하여 NTLM 인증을 SMB로 전달(Relay)하는 공격을 통해 서버의 권한을 탈취할 수 있습니다. 특히 NetLogon 프로토콜의 취약점을 이용한 제로로그온(Zerologon, CVE-2020-1472) 공격은 암호화되지 않은 채널을 통해 DC의 컴퓨터 계정 암호를 재설정하여 도메인 전체를 장악하는 심각한 결과를 초래했습니다. 따라서 보안 채널의 기밀성과 무결성을 강제하는 것은 도메인 보안의 필수 요소입니다.

- **탐지 스크립트 분석**:
  - **명령어**: `Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "RequireSignOrSeal"`
  - **동작**: 이 PowerShell cmdlet은 Windows 레지스트리의 특정 키에 있는 특정 값의 데이터를 읽어옵니다. 스크립트가 접근하는 경로는 시스템의 핵심 보안 설정을 관장하는 로컬 보안 기관(LSA)의 구성 키입니다.
  - **의미**: `RequireSignOrSeal`, `SealSecureChannel`, `SignSecureChannel` 레지스트리 값들은 동일한 이름의 그룹 정책(GPO)에 의해 설정되는 실제 값입니다. 레지스트리를 직접 읽는 것은 GPO 적용 여부와 관계없이 현재 장비에 적용된 최종 정책(Effective Policy)을 가장 확실하게 확인하는 방법입니다. 스크립트는 이 세 가지 값이 모두 `1`(사용)인지 확인하여, 서명과 암호화라는 다층 방어 체계가 모두 활성화되어 있는지 검증합니다. 값 중 하나라도 `0`이거나 존재하지 않으면, 이는 보안 채널 보호에 빈틈이 있음을 의미하므로 '취약'으로 진단합니다.

### 수정 설명
- **보안 원리**: 스크립트는 NetLogon 보안 채널의 데이터 보호 수준을 최고로 높이기 위해, 암호화와 서명을 강제하는 정책을 시스템에 직접 적용합니다. 이를 통해 해당 서버가 DC와 통신할 때 항상 기밀성과 무결성이 보장된 보안 채널만을 사용하도록 강제합니다.

- **수정 스크립트 분석**:
  - **명령어**: `Set-ItemProperty -Path $reg_path -Name $policy -Value 1 -Type DWORD`
  - **동작**: 이 cmdlet은 레지스트리 키의 특정 값을 수정하거나 새로 생성합니다. 스크립트는 이 명령어를 사용하여 취약한 것으로 확인된 정책에 해당하는 레지스트리 값들을 모두 `1`로 설정합니다.
  - **의미**: LSA 키의 값을 직접 수정하는 것은 로컬 보안 정책을 변경하는 가장 직접적인 방법입니다. 이 변경 사항은 NetLogon 서비스에 의해 즉시 인식되어, 이후 생성되는 모든 보안 채널 협상 과정에서 암호화와 서명을 요구하도록 만듭니다. 이는 중간자 공격이나 재전송/릴레이 공격으로부터 시스템의 인증 과정을 효과적으로 보호하는 가장 확실한 기술적 조치입니다.

## MITRE ATT&CK TTP Mapping

- **T1557 (Adversary-in-the-Middle):** 보호되지 않는 보안 채널은 중간자 공격의 완벽한 표적입니다. 공격자는 ARP/DNS 스푸핑 등으로 트래픽 경로를 장악한 뒤, 서버와 DC 간의 NetLogon 인증 협상에 개입하여 인증 정보를 탈취하거나(예: NTLM 해시 캡처), 자신의 악성 서버로 인증을 중계(Relay)하여 다른 시스템에 대한 접근 권한을 획득할 수 있습니다.
- **T1071 (Application Layer Protocol):** NetLogon은 Windows 도메인 인증의 핵심 응용 계층 프로토콜입니다. 암호화되지 않은 NetLogon 트래픽은 공격자에게 도메인 컨트롤러의 정보, 계정 잠금 정책, 도메인 SID 등 내부 구조를 파악할 수 있는 풍부한 정보를 제공합니다. 공격자는 이 정보를 활용하여 패스더해시(Pass-the-Hash) 등 더 정교한 후속 공격을 계획하고 실행할 수 있습니다.
